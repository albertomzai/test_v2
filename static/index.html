<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini-Trello Kanban</title>
    <style>
        :root {
            --bg: #f4f5f7;
            --column-bg: #ebecf0;
            --card-bg: #fff;
            --border-radius: 3px;
            --font-family: system-ui, sans-serif;
            --color-text: #172b4d;
        }
        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--bg);
            color: var(--color-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            padding: 1rem;
            background-color: #026aa7;
            color: #fff;
            text-align: center;
        }
        main {
            flex: 1;
            display: flex;
            gap: 1rem;
            padding: 1rem;
            overflow-x: auto;
        }
        .column {
            background-color: var(--column-bg);
            border-radius: var(--border-radius);
            width: 300px;
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }
        .column h2 {
            margin: 0.5rem;
            font-size: 1.1rem;
        }
        .card-list {
            flex: 1;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
        }
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            box-shadow: 0 1px 0 rgba(9,30,66,.25);
            cursor: grab;
        }
        .card:active {cursor: grabbing;}
        #addTaskBtn {
            margin: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #5aac44;
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
        }
        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal.hidden {display:none;}
        .modal-content {
            background:#fff;
            padding:1rem;
            border-radius:var(--border-radius);
            width: 90%;
            max-width:400px;
        }
        .modal textarea {
            width:100%;
            height:80px;
            margin-bottom:0.5rem;
            padding:0.5rem;
            border:1px solid #ccc;
            border-radius:var(--border-radius);
            resize:none;
        }
        .modal button {
            padding:0.5rem 1rem;
            margin-right:0.5rem;
            border:none;
            border-radius:var(--border-radius);
            cursor:pointer;
        }
        .modal .save {background:#5aac44;color:#fff;}
        .modal .cancel{background:#bbb;color:#fff;}
        /* Messages */
        #message {
            position:fixed;
            top:1rem; right:1rem;
            background:#333;
            color:#fff;
            padding:0.75rem 1rem;
            border-radius:var(--border-radius);
            display:none;
            z-index:1000;
        }
        #message.error{background:#e74c3c;}
    </style>
</head>
<body>
<header><h1>Mini-Trello Kanban</h1></header>
<main id="board">
    <div class="column" data-status="Por Hacer" draggable="false">
        <h2>Por Hacer</h2>
        <button id="addTaskBtn">Añadir Tarea</button>
        <div class="card-list" id="list-por-hacer"></div>
    </div>
    <div class="column" data-status="En Progreso" draggable="false">
        <h2>En Progreso</h2>
        <div class="card-list" id="list-en-progreso"></div>
    </div>
    <div class="column" data-status="Hecho" draggable="false">
        <h2>Hecho</h2>
        <div class="card-list" id="list-hecho"></div>
    </div>
</main>
<div id="message"></div>
<!-- Modal for adding task -->
<div id="addModal" class="modal hidden">
    <div class="modal-content">
        <h3>Añadir nueva tarea</h3>
        <textarea id="newTaskContent" placeholder="Escribe la descripción..."></textarea>
        <button class="save" id="saveNewTask">Guardar</button>
        <button class="cancel" id="cancelNewTask">Cancelar</button>
    </div>
</div>
<script>
// Utility functions
const showMessage = (msg, type='info')=>{
  const el=document.getElementById('message');
  el.textContent=msg;
  el.className=type==='error'?'error':'';
  el.style.display='block';
  setTimeout(()=>{el.style.display='none';},4000);
};
const fetchJson = async (url, opts={})=>{
  const res=await fetch(url,opts);
  if(!res.ok){const err=await res.json();throw new Error(err.message||'Error');}
  return await res.json();
};
// Render functions
const createCardElement=(task)=>{
  const div=document.createElement('div');
  div.className='card';
  div.draggable=true;
  div.dataset.id=task.id;
  div.textContent=task.content;
  // Edit inline
  div.addEventListener('click',()=>{editTask(div,task);});
  // Drag events
  div.addEventListener('dragstart',(e)=>{e.dataTransfer.setData('text/plain',task.id);});
  return div;
};
const renderTasks=tasks=>{
  const columns={"Por Hacer":"list-por-hacer","En Progreso":"list-en-progreso","Hecho":"list-hecho"};
  Object.values(columns).forEach(id=>{document.getElementById(id).innerHTML='';});
  tasks.forEach(t=>{
    const list=document.getElementById(columns[t.status]);
    if(list)list.appendChild(createCardElement(t));
  });
};
// CRUD operations
const loadTasks=async()=>{try{const tasks=await fetchJson('/api/tasks');renderTasks(tasks);}catch(e){showMessage('No se pudieron cargar tareas: '+e.message,'error');}}
const addTask=(content)=>{return fetchJson('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content, status:'Por Hacer'})});}
const updateTask=(id,newData)=>{return fetchJson(`/api/tasks/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(newData)});}
// Edit inline
const editTask=async(div,task)=>{
  const newText=prompt('Editar tarea:',task.content);
  if(newText===null||newText.trim()===task.content) return;
  try{await updateTask(task.id,{content:newText});div.textContent=newText;showMessage('Tarea actualizada');}catch(e){showMessage('Error al actualizar: '+e.message,'error');}
};
// Drag and drop handlers
const allowDrop=(e)=>{e.preventDefault();}
const handleDrop=(e,status)=>{e.preventDefault();const id=e.dataTransfer.getData('text/plain');const card=document.querySelector(`.card[data-id="${id}"]`);if(card){const list= e.currentTarget;list.appendChild(card);updateTask(id,{status});showMessage('Tarea movida a '+status);} }
// Init
document.addEventListener('DOMContentLoaded',()=>{
  loadTasks();
  // Add task modal
  const modal=document.getElementById('addModal');
  document.getElementById('addTaskBtn').onclick=()=>{modal.classList.remove('hidden');}
  document.getElementById('cancelNewTask').onclick=()=>{modal.classList.add('hidden');document.getElementById('newTaskContent').value='';}
  document.getElementById('saveNewTask').onclick=async()=>{
    const content=document.getElementById('newTaskContent').value.trim();
    if(!content){showMessage('Contenido requerido','error');return;}
    try{const newT=await addTask(content);document.getElementById('list-por-hacer').appendChild(createCardElement(newT));modal.classList.add('hidden');document.getElementById('newTaskContent').value='';showMessage('Tarea añadida');}catch(e){showMessage('Error al añadir: '+e.message,'error');}
  };
  // Drag & drop for columns
  document.querySelectorAll('.column .card-list').forEach(col=>{col.addEventListener('dragover',allowDrop);col.addEventListener('drop',e=>handleDrop(e,col.parentElement.dataset.status));});
});
</script>
</body>
</html>