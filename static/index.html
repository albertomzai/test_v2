<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<title>Mini Trello</title>
<style>
  body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f4f5f7;}
  .board{display:flex;height:100vh;padding:20px;gap:10px;box-sizing:border-box;}
  .column{background:#e2e4e6;border-radius:3px;flex:1;display:flex;flex-direction:column;overflow-y:auto;}
  .column h2{text-align:center;background:#dfe1e5;padding:10px;margin:0;font-size:1rem;color:#172b4d;border-bottom:1px solid #cfd8dc;}
  .task{background:white;border-radius:3px;margin:5px 10px;padding:10px;cursor:pointer;box-shadow:0 1px 0 rgba(9,30,66,.25);user-select:none;}
  .task[draggable="true"]{opacity:0.8;}
  .add-task{background:#5aac44;color:white;border:none;padding:10px;margin:5px auto;cursor:pointer;width:90%;border-radius:3px;font-size:1rem;}
  .add-task:hover{background:#519839;}
</style>
</head>
<body>
<div class="board">
  <div class="column" data-state="Por Hacer">
    <h2>Por Hacer</h2>
    <button id="new-task-btn" class="add-task">+ Nueva tarea</button>
    <div id="por-hacer"></div>
  </div>
  <div class="column" data-state="En Progreso">
    <h2>En Progreso</h2>
    <div id="en-progreso"></div>
  </div>
  <div class="column" data-state="Hecho">
    <h2>Hecho</h2>
    <div id="hecho"></div>
  </div>
</div>
<script type="module">
const API_URL = '/api/tasks';

// Fetch tasks from backend and render them
async function cargarTareas(){
  try{
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error('Error al obtener tareas');
    const tareas = await res.json();
    // Clear columns
    document.querySelectorAll('.column > div[id]').forEach(col=>col.innerHTML='');
    tareas.forEach(mostrarTarea);
  }catch(err){
    console.error(err);
  }
}

// Create a task element and append to correct column
function mostrarTarea(task){
  const colDiv = document.getElementById(sanitizeState(task.state));
  if(!colDiv) return;
  const card = document.createElement('div');
  card.className='task';
  card.draggable=true;
  card.dataset.id=task.id;
  card.textContent=task.content;

  // Drag events
  card.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',task.id);});
  card.addEventListener('dblclick',()=>editarTarea(card));

  colDiv.appendChild(card);
}

// Sanitize state string to match element id
function sanitizeState(state){return state.toLowerCase().replace(/\s+/g,'-');}

// Add new task
document.getElementById('new-task-btn').addEventListener('click',async()=>{
  const content = prompt('Contenido de la tarea:');
  if(!content) return;
  try{
    const res = await fetch(API_URL,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content,state:'Por Hacer'})
    });
    if(!res.ok) throw new Error('Error al crear tarea');
    const task = await res.json();
    mostrarTarea(task);
  }catch(err){console.error(err);}
});

// Inline edit
async function editarTarea(card){
  const newContent = prompt('Editar contenido:',card.textContent);
  if(newContent===null||newContent===card.textContent) return;
  const id=card.dataset.id;
  try{
    const res = await fetch(`${API_URL}/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:newContent})});
    if(!res.ok) throw new Error('Error al actualizar tarea');
    card.textContent=newContent;
  }catch(err){console.error(err);}
}

// Drag & Drop handling for columns
document.querySelectorAll('.column').forEach(col=>{
  col.addEventListener('dragover',e=>{e.preventDefault();});
  col.addEventListener('drop',async e=>{
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const card = document.querySelector(`.task[data-id="${id}"]`);
    if(!card) return;
    const newState = col.dataset.state;
    try{
      const res = await fetch(`${API_URL}/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({state:newState})});
      if(!res.ok) throw new Error('Error al mover tarea');
      col.querySelector('#'+sanitizeState(newState)).appendChild(card);
    }catch(err){console.error(err);}
  });
});

// Initial load
cargarTareas();
</script>
</body>
</html>