<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Simulador de Hipotecas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        form { max-width: 400px; margin-bottom: 1.5rem; }
        label { display: block; margin-top: 0.75rem; }
        input[type="number"] { width: 100%; padding: 0.5rem; box-sizing: border-box; }
        button { margin-top: 1rem; padding: 0.6rem 1.2rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: right; }
        th { background-color: #f4f4f4; }
    </style>
</head>
<body>
    <h1>Simulador de Hipotecas</h1>
    <form id="hipoteca-form">
        <label for="importe">Importe del préstamo (€):
            <input type="number" id="importe" name="importe" step="0.01" required min="0">
        </label>
        <label for="tasa_interes">Tasa de interés anual (%):
            <input type="number" id="tasa_interes" name="tasa_interes" step="0.01" required min="0">
        </label>
        <label for="plazo">Plazo (meses):
            <input type="number" id="plazo" name="plazo" step="1" required min="1">
        </label>
        <button type="submit">Calcular</button>
    </form>

    <div id="resultado"></div>

    <script>
        /**
         * Envía los datos del formulario al endpoint /api/hipoteca y muestra la tabla de amortización.
         */
        document.getElementById('hipoteca-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const importe = parseFloat(document.getElementById('importe').value);
            const tasa_interes = parseFloat(document.getElementById('tasa_interes').value);
            const plazo = parseInt(document.getElementById('plazo').value, 10);

            const payload = { importe, tasa_interes, plazo };

            try {
                const response = await fetch('/api/hipoteca', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                renderTable(data.cuotas);
            } catch (err) {
                document.getElementById('resultado').innerHTML = `<p style="color:red;">${err.message}</p>`;
            }
        });

        /**
         * Genera una tabla HTML a partir de la lista de cuotas.
         * @param {Array} cuotas - Lista de objetos con mes, pago, interes, principal y saldo.
         */
        function render_table(cuotas) {
            if (!Array.isArray(cuotas) || cuotas.length === 0) {
                document.getElementById('resultado').innerHTML = '<p>No hay datos para mostrar.</p>';
                return;
            }

            let tableHtml = `<table><thead><tr>`;
            const headers = ['Mes', 'Pago (€)', 'Interés (€)', 'Principal (€)', 'Saldo (€)'];
            headers.forEach(header => {
                tableHtml += `<th>${header}</th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            cuotas.forEach(cuota => {
                tableHtml += `<tr>`;
                tableHtml += `<td style="text-align:center;">${cuota.mes}</td>`;
                tableHtml += `<td>${formatNumber(cuota.pago)}</td>`;
                tableHtml += `<td>${formatNumber(cuota.interes)}</td>`;
                tableHtml += `<td>${formatNumber(cuota.principal)}</td>`;
                tableHtml += `<td>${formatNumber(cuota.saldo)}</td>`;
                tableHtml += `</tr>`;
            });

            tableHtml += `</tbody></table>`;
            document.getElementById('resultado').innerHTML = tableHtml;
        }

        /**
         * Formatea un número a dos decimales con separador de miles.
         * @param {number} value - Número a formatear.
         * @returns {string}
         */
        function format_number(value) {
            return value.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    </script>
</body>
</html>