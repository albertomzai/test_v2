<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Simulador de Hipotecas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        form { margin-bottom: 1.5rem; }
        label { display: block; margin-top: 0.5rem; }
        input[type="number"] { width: 100%; padding: 0.4rem; margin-top: 0.2rem; }
        button { margin-top: 1rem; padding: 0.6rem 1.2rem; }
        #mensaje_error { color: red; margin-top: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ccc; padding: 0.4rem; text-align: right; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Simulador de Hipotecas</h1>

    <form id="hipoteca_form">
        <label for="monto_input">Monto del préstamo (€):
            <input type="number" id="monto_input" name="monto" min="0" step="any" required />
        </label>
        <label for="tasa_input">Tasa de interés (% anual):
            <input type="number" id="tasa_input" name="tasa" min="0" step="any" required />
        </label>
        <label for="plazo_input">Plazo (meses):
            <input type="number" id="plazo_input" name="plazo" min="1" step="1" required />
        </label>
        <button type="submit">Calcular</button>
    </form>

    <div id="mensaje_error"></div>

    <table id="tabla_amortizacion">
        <thead>
            <tr>
                <th>Cuota #</th>
                <th>Monto de Cuota (€)</th>
                <th>Interés (€)</th>
                <th>Principal (€)</n>
                <th>Saldo Restante (€)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script type="text/javascript">
        /**
         * Captura el envío del formulario, evita la recarga y envía los datos al backend.
         */
        document.getElementById('hipoteca_form').addEventListener('submit', function (event) {
            event.preventDefault(); // Evita la recarga de página
            const monto = parseFloat(document.getElementById('monto_input').value);
            const tasa = parseFloat(document.getElementById('tasa_input').value);
            const plazo = parseInt(document.getElementById('plazo_input').value, 10);

            // Validaciones básicas
            if (isNaN(monto) || monto <= 0) {
                mostrar_error('El monto debe ser un número positivo.');
                return;
            }
            if (isNaN(tasa) || tasa < 0) {
                mostrar_error('La tasa debe ser un número no negativo.');
                return;
            }
            if (isNaN(plazo) || plazo <= 0) {
                mostrar_error('El plazo debe ser al menos 1 mes.');
                return;
            }

            // Construir cuerpo de la petición
            const datos = { monto: monto, tasa: tasa, plazo: plazo };

            fetch('/api/hipoteca', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor.');
                }
                return response.json();
            })
            .then(respuesta => {
                // Limpiar mensajes y tabla
                document.getElementById('mensaje_error').textContent = '';
                const tbody = document.querySelector('#tabla_amortizacion tbody');
                tbody.innerHTML = '';

                respuesta.forEach(fila => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${fila.cuota}</td>
                        <td>${formatCurrency(fila.monto_cuota)}</td>
                        <td>${formatCurrency(fila.interes)}</td>
                        <td>${formatCurrency(fila.principal)}</td>
                        <td>${formatCurrency(fila.saldo_restante)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(error => {
                mostrar_error(error.message || 'Error inesperado.');
            });
        });

        /**
         * Muestra un mensaje de error al usuario.
         * @param {string} msg - Mensaje a mostrar.
         */
        function mostrar_error(msg) {
            document.getElementById('mensaje_error').textContent = msg;
        }

        /**
         * Formatea número como moneda en euros.
         * @param {number} valor
         * @returns {string}
         */
        function formatCurrency(valor) {
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(valor);
        }
    </script>
</body>
</html>