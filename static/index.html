<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Simulador de Hipotecas</title>
    <style>
        body {font-family: Arial, sans-serif; margin: 2rem;}
        form {max-width: 400px; margin-bottom: 1.5rem;}
        label {display: block; margin-top: 0.75rem;}
        input[type="number"] {width: 100%; padding: 0.4rem; margin-top: 0.25rem;}
        button {margin-top: 1rem; padding: 0.6rem 1.2rem; cursor: pointer;}
        table {border-collapse: collapse; width: 100%; margin-top: 1.5rem;}
        th, td {border: 1px solid #ddd; padding: 0.5rem; text-align: right;}
        th {background-color: #f2f2f2;}
        .error {color: red; margin-top: 0.5rem;}
    </style>
</head>
<body>
    <h1>Simulador de Hipotecas</h1>
    <form id="hipoteca-form">
        <label for="monto">Importe del préstamo (€):
            <input type="number" id="monto" name="monto" min="0" step="0.01" required />
        </label>
        <label for="tasa_interes">Tasa de interés anual (%):
            <input type="number" id="tasa_interes" name="tasa_interes" min="0" step="0.01" required />
        </label>
        <label for="plazo_años">Plazo en años:
            <input type="number" id="plazo_años" name="plazo_años" min="1" step="1" required />
        </label>
        <button type="submit">Calcular</button>
    </form>
    <div class="error" id="error-msg"></div>
    <table id="tabla-amortizacion" hidden>
        <thead>
            <tr>
                <th>Pago #</th>
                <th>Principal (€)</th>
                <th>Interés (€)</th>
                <th>Saldo Restante (€)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script type="module">
        const form = document.getElementById('hipoteca-form');
        const errorMsg = document.getElementById('error-msg');
        const tabla = document.getElementById('tabla-amortizacion');
        const tbody = tabla.querySelector('tbody');

        /**
         * Convierte los valores del formulario a un objeto JSON.
         * @returns {{monto: number, tasa_interes: number, plazo: number}}
         */
        function obtener_datos_formulario() {
            const monto = parseFloat(document.getElementById('monto').value);
            const tasa_interes = parseFloat(document.getElementById('tasa_interes').value) / 100;
            const plazo = parseInt(document.getElementById('plazo_años').value, 10);
            return { monto, tasa_interes, plazo };
        }

        /**
         * Renderiza la tabla de amortización en el DOM.
         * @param {{principal: number, interes: number, saldo_restante: number}[]} pagos
         */
        function render_tabla_amortizacion(pagos) {
            tbody.innerHTML = '';
            pagos.forEach((pago, index) => {
                const fila = document.createElement('tr');
                fila.innerHTML = `<td>${index + 1}</td>
                                  <td>${pago.principal.toFixed(2)}</td>
                                  <td>${pago.interes.toFixed(2)}</td>
                                  <td>${pago.saldo_restante.toFixed(2)}</td>`;
                tbody.appendChild(fila);
            });
            tabla.hidden = false;
        }

        /**
         * Maneja la respuesta del servidor y muestra errores o datos.
         * @param {Response} response
         */
        async function procesar_respuesta(response) {
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Error al procesar la solicitud');
            }
            const data = await response.json();
            render_tabla_amortizacion(data.pagos);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.textContent = '';
            tabla.hidden = true;
            try {
                const datos = obtener_datos_formulario();
                if (!datos.monto || !datos.tasa_interes || !datos.plazo) {
                    throw new Error('Todos los campos son obligatorios');
                }

                const response = await fetch('/api/hipoteca', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                await procesar_respuesta(response);
            } catch (err) {
                errorMsg.textContent = err.message;
            }
        });
    </script>
</body>
</html>